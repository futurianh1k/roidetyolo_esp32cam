# ============================================================
# YOLO 검출 서버 Docker Compose (Jetson JetPack 6.x 전용)
# 사용법: docker-compose -f docker-compose.jp6.yml up -d
# ============================================================

version: '3.8'

services:
  yolo:
    build:
      context: ../..
      dockerfile: docker/yolo-jetson/Dockerfile.jp6
    container_name: yolo-detector
    restart: unless-stopped
    
    # NVIDIA GPU 접근
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video
      
      # 앱 설정
      - YOLO_MODEL=${YOLO_MODEL:-/app/models/yolov8n.pt}
      - YOLO_FORCE_CPU=${YOLO_FORCE_CPU:-false}
      - STORAGE_PATH=/app/detection_results
      - STORAGE_MAX_MB=${STORAGE_MAX_MB:-500}
      
      # Streamlit 설정
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      
      # 시간대
      - TZ=Asia/Seoul
    
    ports:
      - "8501:8501"
      - "8082:8082"
    
    volumes:
      - yolo_results:/app/detection_results
      - yolo_models:/app/models
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    networks:
      - yolo-network

volumes:
  yolo_results:
  yolo_models:

networks:
  yolo-network:
    driver: bridge
