# ============================================================
# ASR 서버 Docker Compose (RK3588 전용)
# 대상: Rockchip RK3588 보드 (Orange Pi 5, Rock 5B 등)
# ============================================================

version: '3.8'

services:
  asr:
    build:
      context: ../..
      dockerfile: docker/rk3588-asr/Dockerfile
    container_name: rk3588-asr
    restart: unless-stopped
    
    # 장치 접근 (NPU, 사운드)
    devices:
      # NPU 장치
      - /dev/dri:/dev/dri
      # 사운드 장치 (마이크 입력용)
      - /dev/snd:/dev/snd
    
    # 권한 설정
    privileged: false
    group_add:
      - audio
      - video
      - render
    
    environment:
      # ASR 설정
      - ASR_MODEL_PATH=/app/models
      - ASR_SERVER_PORT=8081
      - ASR_SERVER_HOST=0.0.0.0
      
      # 백엔드 연결 (결과 전송용)
      - BACKEND_URL=${BACKEND_URL:-http://host.docker.internal:8000}
      - BACKEND_API_KEY=${BACKEND_API_KEY:-}
      
      # 로그 레벨
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # 시간대
      - TZ=Asia/Seoul
    
    ports:
      - "8081:8081"  # ASR API
    
    volumes:
      # 모델 파일 (호스트에서 복사)
      - ./models:/app/models:ro
      
      # 로그
      - asr_logs:/app/logs
      
      # RKNN 라이브러리 (호스트에서 마운트)
      - /usr/lib/aarch64-linux-gnu/librknnrt.so:/usr/lib/aarch64-linux-gnu/librknnrt.so:ro
    
    # 리소스 제한
    deploy:
      resources:
        limits:
          memory: 2G
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    
    networks:
      - asr-network

  # ============================================================
  # Redis (세션 관리용, 선택)
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: rk3588-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - asr-network

volumes:
  asr_logs:
  redis_data:

networks:
  asr-network:
    driver: bridge
