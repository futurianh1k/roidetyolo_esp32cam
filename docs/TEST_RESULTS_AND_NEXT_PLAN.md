# 테스트 결과 분석 및 후속 개발 계획

**작성일**: 2025-01-13  
**버전**: 1.2  
**최종 업데이트**: 2025-01-13

> **v1.2 변경사항**: 펌웨어 상태 전송 및 MQTT 명령 처리 구현 완료

---

## 1. 테스트 결과 요약

### 1.1 백엔드 API 테스트

| 항목            | 값             |
| --------------- | -------------- |
| 총 엔드포인트   | 37개           |
| 테스트 커버리지 | 62% (23/37)    |
| 테스트 상태     | ✅ 문서화 완료 |

**API 그룹별 커버리지:**

| API 그룹        | 커버리지    | 비고               |
| --------------- | ----------- | ------------------ |
| 시스템 API      | 100% (2/2)  | ✅ 완료            |
| 인증 API        | 100% (5/5)  | ✅ 완료            |
| 사용자 관리 API | 0% (0/6)    | ⚠️ ADMIN 권한 필요 |
| 장비 관리 API   | 87.5% (7/8) | ✅ 대부분 완료     |
| 장비 제어 API   | 100% (5/5)  | ✅ 완료            |
| 오디오 파일 API | 50% (2/4)   | ⚠️ 부분 완료       |
| ASR API         | 33% (2/6)   | ⚠️ ASR 서버 필요   |
| WebSocket API   | 0% (0/1)    | ⚠️ 별도 도구 필요  |

### 1.2 E2E 테스트 (Selenium)

| 항목             | 값                          |
| ---------------- | --------------------------- |
| 총 테스트 케이스 | 21개                        |
| 실행 결과        | 15 Errors (서버 미실행)     |
| 테스트 상태      | ⚠️ 환경 설정 후 재실행 필요 |

**테스트 실패 원인:**

- 프론트엔드 서버 (`localhost:3000`) 미실행
- 백엔드 서버 (`localhost:8000`) 미실행
- Chrome 드라이버 연결 문제

### 1.3 현재 기능 상태

| 기능 영역  | 동작  | 부분 동작 | 미구현 |
| ---------- | ----- | --------- | ------ |
| 대시보드   | 4     | 2         | 2      |
| 장비 상세  | 3     | 6         | 1      |
| 백엔드 API | 2     | 4         | 0      |
| **합계**   | **9** | **12**    | **3**  |

---

## 2. 발견된 이슈 및 기술 부채

### 2.1 🔴 높은 우선순위 (보안/기능 장애)

| ID       | 이슈                   | 위치                               | 영향도         |
| -------- | ---------------------- | ---------------------------------- | -------------- |
| SEC-001  | 인증 비활성화 상태     | `dashboard/page.tsx`, `devices.py` | 보안 취약      |
| SEC-002  | 더미 사용자 하드코딩   | `dashboard/page.tsx`               | 인증 우회      |
| SEC-003  | localStorage 토큰 저장 | `authStore.ts`                     | XSS 취약점     |
| FUNC-001 | 비디오 스트림 미구현   | `VideoPlayer.tsx`                  | 핵심 기능 누락 |

### 2.2 🟡 중간 우선순위 (기능 미완성)

| ID       | 이슈                      | 위치                        | 영향도              |
| -------- | ------------------------- | --------------------------- | ------------------- |
| FUNC-002 | ASR 통계 차트 미연동      | `ASRStatsChart.tsx`         | 대시보드 불완전     |
| FUNC-003 | 응급 알림 히스토리 미연동 | `EmergencyAlertHistory.tsx` | 알림 기능 누락      |
| FUNC-004 | 장비 제어 응답 미확인     | `DeviceControl.tsx`         | UX 개선 필요        |
| INT-001  | MQTT 브로커 연동 불안정   | 백엔드                      | 제어 명령 실패 가능 |
| INT-002  | ASR 서버 연동 미완성      | 백엔드/펌웨어               | 음성인식 불가       |

### 2.3 🟢 낮은 우선순위 (개선사항)

| ID      | 이슈                     | 위치            | 영향도      |
| ------- | ------------------------ | --------------- | ----------- |
| UX-001  | 에러 바운더리 없음       | 프론트엔드 전체 | 사용자 경험 |
| UX-002  | 로딩 상태 불일치         | 여러 컴포넌트   | 사용자 경험 |
| DEV-001 | 테스트 커버리지 부족     | 전체            | 품질 보증   |
| DEV-002 | 펌웨어 민감정보 하드코딩 | `config.h`      | 보안        |

---

## 3. 후속 개발 계획 (수정된 버전)

### Phase 0: 테스트 환경 안정화 (3일)

**목표**: E2E 테스트가 정상 실행되도록 환경 구축

| 작업                                 | 담당   | 예상 시간 | 우선순위 |
| ------------------------------------ | ------ | --------- | -------- |
| 프론트엔드/백엔드 Docker 컴포즈 작성 | DevOps | 4h        | 🔴       |
| E2E 테스트 실행 스크립트 개선        | QA     | 2h        | 🔴       |
| CI/CD 파이프라인에 테스트 통합       | DevOps | 4h        | 🟡       |
| 테스트 실패 케이스 수정              | FE/BE  | 4h        | 🔴       |

**완료 기준:**

- [ ] `docker-compose up`으로 전체 환경 실행 가능
- [ ] `.\run_tests.ps1`로 E2E 테스트 통과 (15/21 이상)
- [ ] 테스트 리포트 자동 생성

### Phase 1: 인증 시스템 활성화 (1주)

**목표**: 보안 취약점 해결 및 실제 인증 시스템 활성화

| 작업                          | 담당  | 예상 시간 | 우선순위 |
| ----------------------------- | ----- | --------- | -------- |
| 백엔드 인증 미들웨어 활성화   | BE    | 4h        | 🔴       |
| 프론트엔드 로그인 페이지 연동 | FE    | 4h        | 🔴       |
| 토큰 갱신 로직 구현           | FE    | 4h        | 🔴       |
| HttpOnly 쿠키 전환            | FE/BE | 8h        | 🟡       |
| E2E 인증 테스트 활성화        | QA    | 2h        | 🟡       |

**완료 기준:**

- [ ] 모든 API 엔드포인트에 인증 적용
- [ ] 로그인/로그아웃 정상 동작
- [ ] 토큰 만료 시 자동 갱신
- [ ] TC-AUTH-\* 테스트 통과

### Phase 2: 장비 통신 안정화 (2주)

**목표**: 펌웨어 ↔ 백엔드 ↔ 프론트엔드 통신 완성

| 작업                       | 담당  | 예상 시간 | 우선순위 |
| -------------------------- | ----- | --------- | -------- |
| 펌웨어 상태 전송 구현      | FW    | 8h        | 🔴       |
| MQTT 제어 명령 테스트      | BE/FW | 8h        | 🔴       |
| 제어 명령 응답 피드백 구현 | FE/BE | 8h        | 🟡       |
| MJPEG 카메라 스트리밍      | FW    | 16h       | 🔴       |
| VideoPlayer 컴포넌트 연동  | FE    | 8h        | 🔴       |
| 오디오 다운로드/재생       | FW    | 8h        | 🟡       |

**완료 기준:**

- [ ] 장비 상태 실시간 업데이트
- [ ] 카메라 시작/정지 제어 동작
- [ ] 비디오 스트림 프론트엔드 표시
- [ ] TC-DEV-\* 테스트 통과 (온라인 장비 필요)

### Phase 3: 음성인식 통합 (2주)

**목표**: ASR 서버 연동 및 음성인식 기능 완성

| 작업                    | 담당   | 예상 시간 | 우선순위 |
| ----------------------- | ------ | --------- | -------- |
| ASR 서버 배포/설정      | DevOps | 8h        | 🔴       |
| 펌웨어 오디오 스트리밍  | FW     | 16h       | 🔴       |
| ASR 결과 수신 및 표시   | FE/BE  | 8h        | 🔴       |
| 응급 키워드 감지 알림   | BE/FE  | 8h        | 🟡       |
| ASR 통계 API 구현       | BE     | 8h        | 🟡       |
| 대시보드 통계 차트 연동 | FE     | 4h        | 🟡       |

**완료 기준:**

- [ ] 음성인식 세션 시작/종료 동작
- [ ] 인식 결과 실시간 표시
- [ ] 응급 상황 알림 동작
- [ ] TC-ASR-\* 테스트 통과

### Phase 4: 품질 및 보안 강화 (1주)

**목표**: 테스트 커버리지 향상 및 보안 강화

| 작업                        | 담당 | 예상 시간 | 우선순위 |
| --------------------------- | ---- | --------- | -------- |
| 사용자 관리 API 테스트 추가 | QA   | 4h        | 🟡       |
| WebSocket 테스트 추가       | QA   | 4h        | 🟡       |
| 펌웨어 NVS 민감정보 이동    | FW   | 4h        | 🟡       |
| 에러 바운더리 구현          | FE   | 4h        | 🟢       |
| 감사 로그 조회 UI           | FE   | 8h        | 🟢       |
| 성능 테스트 추가            | QA   | 8h        | 🟢       |

**완료 기준:**

- [ ] 백엔드 API 테스트 커버리지 80% 이상
- [ ] E2E 테스트 100% 통과
- [ ] 보안 스캔 통과

---

## 4. 테스트 실행 가이드

### 4.1 환경 준비

```bash
# 1. 백엔드 실행
cd backend
pip install -r requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 2. 프론트엔드 실행 (별도 터미널)
cd frontend
npm install
npm run dev

# 3. MQTT 브로커 (선택사항)
docker run -d -p 1883:1883 -p 9001:9001 eclipse-mosquitto
```

### 4.2 E2E 테스트 실행

```powershell
cd e2e

# 의존성 설치 (최초 1회)
.\run_tests.ps1 -Install

# 테스트 실행
.\run_tests.ps1

# 브라우저 표시 모드 (디버깅)
.\run_tests.ps1 -Headless $false

# HTML 리포트 생성
.\run_tests.ps1 -Report
```

### 4.3 백엔드 API 테스트 실행

```bash
cd backend
python test_all_apis.py
```

---

## 5. 마일스톤 일정

| 마일스톤                   | 목표 일자      | 상태    |
| -------------------------- | -------------- | ------- |
| Phase 0 완료 (테스트 환경) | 2025-01-16     | ⬜ 대기 |
| Phase 1 완료 (인증 활성화) | 2025-01-23     | ⬜ 대기 |
| Phase 2 완료 (장비 통신)   | 2025-02-06     | ⬜ 대기 |
| Phase 3 완료 (음성인식)    | 2025-02-20     | ⬜ 대기 |
| Phase 4 완료 (품질 강화)   | 2025-02-27     | ⬜ 대기 |
| **전체 완료**              | **2025-02-27** | ⬜ 대기 |

---

## 6. 위험 요소 및 대응 방안

| 위험               | 영향도 | 대응 방안                                |
| ------------------ | ------ | ---------------------------------------- |
| ASR 서버 접근 불가 | 높음   | 로컬 ASR 서버 대안 또는 Mock 서비스 구현 |
| MQTT 브로커 불안정 | 중간   | Docker 컨테이너화 및 헬스 체크 추가      |
| 펌웨어 개발 지연   | 높음   | 하드웨어 시뮬레이터 구현                 |
| 테스트 환경 불일치 | 중간   | Docker Compose로 환경 통일               |

---

## 7. 완료된 개선 사항 (2025-01-13)

### 7.1 장비 실시간 상태 표시 (프론트엔드)

| 항목     | 변경 내용                                            |
| -------- | ---------------------------------------------------- |
| 파일     | `frontend/src/app/dashboard/page.tsx`                |
| 기능     | 각 장비의 최신 상태를 조회하여 DeviceCard에 표시     |
| 세부사항 | `useQueries`를 사용한 병렬 상태 조회, 10초 자동 갱신 |

**변경 코드:**

```typescript
// 각 장비의 최신 상태 조회
const deviceStatusQueries = useQueries({
  queries: (devicesData?.devices || []).map((device) => ({
    queryKey: ["deviceStatus", device.id],
    queryFn: async () => {
      /* 상태 조회 */
    },
    refetchInterval: 10000, // 10초마다 자동 갱신
  })),
});
```

### 7.2 장비 온라인/오프라인 상태 자동 판정 (백엔드)

| 항목     | 변경 내용                                           |
| -------- | --------------------------------------------------- |
| 파일     | `backend/app/api/devices.py`                        |
| 기능     | `last_seen_at` 기준 60초 초과 시 자동 오프라인 판정 |
| 세부사항 | 장비 목록 조회/상세 조회 시 상태 자동 업데이트      |

**변경 코드:**

```python
DEVICE_OFFLINE_THRESHOLD_SECONDS = 60

def update_device_online_status(db: Session, device: Device) -> bool:
    """장비의 온라인 상태를 last_seen_at 기준으로 업데이트"""
    if device.last_seen_at is None:
        return False

    time_since_last_seen = (datetime.utcnow() - device.last_seen_at).total_seconds()

    if time_since_last_seen > DEVICE_OFFLINE_THRESHOLD_SECONDS:
        device.is_online = False
        return False
    else:
        device.is_online = True
        return True
```

### 7.3 API 인증 비활성화 통일 (백엔드)

| API                               | 인증 상태          |
| --------------------------------- | ------------------ |
| `GET /devices/`                   | ⚠️ 비활성화 (TODO) |
| `GET /devices/{id}`               | ⚠️ 비활성화 (TODO) |
| `POST /devices/`                  | ⚠️ 비활성화 (TODO) |
| `PUT /devices/{id}`               | ⚠️ 비활성화 (TODO) |
| `DELETE /devices/{id}`            | ⚠️ 비활성화 (TODO) |
| `POST /devices/{id}/status`       | ⚠️ 비활성화 (TODO) |
| `GET /devices/{id}/status`        | ⚠️ 비활성화 (TODO) |
| `GET /devices/{id}/status/latest` | ⚠️ 비활성화 (TODO) |

> ⚠️ 인증이 임시로 비활성화되어 있습니다. Phase 1 (인증 시스템 활성화) 시 활성화 예정.

### 7.4 장비 삭제 시 연관 데이터 처리

장비 삭제 시 다음 데이터가 자동으로 삭제됩니다 (Cascade):

| 테이블             | 동작         |
| ------------------ | ------------ |
| `device_status`    | CASCADE 삭제 |
| `asr_results`      | CASCADE 삭제 |
| `emergency_alerts` | CASCADE 삭제 |
| `audit_logs`       | SET NULL     |

---

## 8. 현재 기능 상태 요약

### 장비 통신/관리 기능

| 기능             | 백엔드   | 프론트엔드    | 펌웨어  | 상태      |
| ---------------- | -------- | ------------- | ------- | --------- |
| 장비 등록        | ✅       | ✅            | -       | ✅ 완료   |
| 장비 삭제        | ✅       | ✅            | -       | ✅ 완료   |
| 장비 목록 조회   | ✅       | ✅            | -       | ✅ 완료   |
| 장비 상세 조회   | ✅       | ✅            | -       | ✅ 완료   |
| 장비 정보 수정   | ✅       | ✅            | -       | ✅ 완료   |
| 장비 상태 기록   | ✅       | -             | ⚠️ 필요 | 🟡 부분   |
| 장비 상태 조회   | ✅       | ✅            | -       | ✅ 완료   |
| 장비 온라인 판정 | ✅       | ✅            | ⚠️ 필요 | 🟡 부분   |
| 장비 제어 (MQTT) | ✅       | ✅            | ⚠️ 필요 | 🟡 부분   |
| 비디오 스트리밍  | ⚠️ URL만 | ⚠️ 컴포넌트만 | ⚠️ 필요 | 🔴 미완성 |

### 다음 단계 필요 작업

✅ **완료됨 (v1.2)**:

1. **펌웨어 상태 전송 구현**

   - `StatusReporter` 클래스 구현 (`status/status_reporter.cc`)
   - `BackendClient` HTTP 클라이언트 구현 (`network/backend_client.cc`)
   - 10초 주기로 `POST /devices/{id}/status` 자동 호출
   - 메모리 사용량, 카메라/마이크 상태 전송

2. **펌웨어 MQTT 명령 수신 구현**
   - 카메라 시작/정지/일시정지: `/control/camera`
   - 마이크(ASR) 시작/정지: `/control/microphone`
   - 스피커 제어: `/control/speaker`
   - 디스플레이 제어: `/control/display`
   - 시스템 재시작: `/control/system`

🔜 **다음 단계**:

1. **펌웨어 빌드 및 테스트**
2. **실제 장비 연동 테스트**
3. **Phase 0: 테스트 환경 안정화**

   - 디스플레이 텍스트 표시

4. **비디오 스트리밍 구현**
   - 펌웨어: MJPEG 스트림 서버
   - 프론트엔드: VideoPlayer 컴포넌트 연동

---

## 9. 참고 문서

- [API 테스트 보고서](./API_TEST_REPORT.md)
- [개발 계획 2025-01](./DEVELOPMENT_PLAN_2025-01.md)
- [코드 리뷰 및 계획](./CURRENT_CODE_REVIEW_AND_PLAN.md)
- [E2E 테스트 가이드](../e2e/README.md)

---

**다음 단계**: Phase 0 (테스트 환경 안정화) 또는 펌웨어 상태 전송 구현
