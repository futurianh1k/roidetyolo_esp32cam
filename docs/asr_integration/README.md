# ìŒì„±ì¸ì‹ ì‹œìŠ¤í…œ í†µí•© ë¬¸ì„œ

CoreS3 ì¥ë¹„ ì›ê²© ê´€ë¦¬ ì‹œìŠ¤í…œì— ì‹¤ì‹œê°„ ìŒì„±ì¸ì‹ ê¸°ëŠ¥ì„ í†µí•©í•œ í”„ë¡œì íŠ¸ ë¬¸ì„œì…ë‹ˆë‹¤.

**í”„ë¡œì íŠ¸**: M5Stack Core S3 Device Management System  
**ë²„ì „**: 1.0.0  
**ì‘ì„±ì¼**: 2025-12-08

---

## ğŸ“ ë¬¸ì„œ êµ¬ì¡°

| ë¬¸ì„œ                        | ì„¤ëª…                       | ëŒ€ìƒ ë…ì                        |
| --------------------------- | -------------------------- | -------------------------------- |
| **01_architecture.md**      | ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì „ì²´ ê°œìš”  | ê°œë°œì, ì•„í‚¤í…íŠ¸                 |
| **02_api_specification.md** | REST API ë° WebSocket ëª…ì„¸ | ë°±ì—”ë“œ ê°œë°œì, í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì |
| **03_functions_detail.md**  | í•¨ìˆ˜ë³„ ìƒì„¸ ì„¤ëª…           | ê°œë°œì                           |
| **04_deployment_guide.md**  | ë°°í¬ ë° ìš´ì˜ ê°€ì´ë“œ        | DevOps, ì‹œìŠ¤í…œ ê´€ë¦¬ì            |
| **README.md**               | ì´ ë¬¸ì„œ (ì „ì²´ ìš”ì•½)        | ëª¨ë“  ì‚¬ìš©ì                      |

---

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

### ëª©ì 

M5Stack CoreS3 ì¥ë¹„ì—ì„œ ì‹¤ì‹œê°„ ìŒì„±ì„ ì¸ì‹í•˜ê³ , ì¸ì‹ ê²°ê³¼ë¥¼ ì¥ë¹„ ë””ìŠ¤í”Œë ˆì´ì™€ ì›¹ í”„ë¡ íŠ¸ì—”ë“œì— í‘œì‹œí•˜ëŠ” í†µí•© ì‹œìŠ¤í…œ êµ¬ì¶•.

### ì£¼ìš” ê¸°ëŠ¥

- âœ… **ì‹¤ì‹œê°„ ìŒì„±ì¸ì‹**: CoreS3 ë§ˆì´í¬ â†’ ASR ì„œë²„ â†’ í…ìŠ¤íŠ¸ ë³€í™˜
- âœ… **ì–‘ë°©í–¥ í‘œì‹œ**: CoreS3 ë””ìŠ¤í”Œë ˆì´ + ì›¹ ì±„íŒ… ì°½
- âœ… **ì‘ê¸‰ ìƒí™© ê°ì§€**: íŠ¹ì • í‚¤ì›Œë“œ ê°ì§€ ì‹œ ìë™ ì•Œë¦¼
- âœ… **ë‹¤ì¤‘ ì„¸ì…˜**: ì—¬ëŸ¬ ì¥ë¹„ ë™ì‹œ ìŒì„±ì¸ì‹ ì§€ì›
- âœ… **VAD (Voice Activity Detection)**: ìŒì„± êµ¬ê°„ ìë™ ê°ì§€

---

## ğŸ—ï¸ ì‹œìŠ¤í…œ êµ¬ì„±

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CoreS3     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   FastAPI    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  ASR Server  â”‚
â”‚   Firmware   â”‚  MQTT   â”‚   Backend    â”‚  HTTP   â”‚ (Sherpa-ONNX)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚
       â”‚ WebSocket              â”‚ WebSocket              â”‚ VAD + STT
       â”‚ (Audio)                â”‚ (Monitor)              â”‚
       â”‚                        â”‚                        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Next.js     â”‚
                        â”‚  Frontend    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì»´í¬ë„ŒíŠ¸ ì—­í• 

| ì»´í¬ë„ŒíŠ¸       | ì—­í•                 | ê¸°ìˆ  ìŠ¤íƒ                       |
| -------------- | ------------------- | ------------------------------- |
| **ASR Server** | ìŒì„± â†’ í…ìŠ¤íŠ¸ ë³€í™˜  | Sherpa-ONNX, FastAPI, WebSocket |
| **Backend**    | API ì¤‘ê³„, ì¥ë¹„ ê´€ë¦¬ | FastAPI, MQTT, WebSocket        |
| **Firmware**   | ì˜¤ë””ì˜¤ ìº¡ì²˜, ì œì–´   | Arduino, I2S, WebSocket         |
| **Frontend**   | ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤   | Next.js, React, WebSocket       |

---

## ğŸ“Š ë°ì´í„° í”Œë¡œìš°

### ìŒì„±ì¸ì‹ í”„ë¡œì„¸ìŠ¤

1. **ì‚¬ìš©ì**: ì›¹ì—ì„œ "ìŒì„±ì¸ì‹ ì‹œì‘" ë²„íŠ¼ í´ë¦­
2. **Frontend**: ë°±ì—”ë“œì— ì„¸ì…˜ ì‹œì‘ ìš”ì²­ (HTTP POST)
3. **Backend**:
   - ASR ì„œë²„ì— ì„¸ì…˜ ìƒì„± ìš”ì²­
   - MQTTë¡œ CoreS3ì— `start_asr` ëª…ë ¹ ì „ì†¡
4. **CoreS3**:
   - WebSocketìœ¼ë¡œ ASR ì„œë²„ ì—°ê²°
   - I2S ë§ˆì´í¬ ì‹œì‘, ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°
5. **ASR Server**:
   - ì˜¤ë””ì˜¤ ìˆ˜ì‹  (Base64 PCM)
   - VADë¡œ ìŒì„± êµ¬ê°„ ê°ì§€
   - Sherpa-ONNXë¡œ í…ìŠ¤íŠ¸ ë³€í™˜
   - WebSocketìœ¼ë¡œ ê²°ê³¼ ì „ì†¡
6. **CoreS3**: ë””ìŠ¤í”Œë ˆì´ì— í…ìŠ¤íŠ¸ í‘œì‹œ
7. **Frontend**: ì±„íŒ… ì°½ì— íˆìŠ¤í† ë¦¬ í‘œì‹œ

---

## ğŸ”§ êµ¬í˜„ ìƒíƒœ

### Phase 1: ASR ì„œë²„ í™•ì¥ âœ… (ì™„ë£Œ)

| í•­ëª©         | ìƒíƒœ | ì„¤ëª…                         |
| ------------ | ---- | ---------------------------- |
| FastAPI ì„œë²„ | âœ…   | WebSocket + REST API         |
| ì„¸ì…˜ ê´€ë¦¬    | âœ…   | SessionManager (ì‹±ê¸€í†¤)      |
| VAD í†µí•©     | âœ…   | VADStreamingProcessor ì¬ì‚¬ìš© |
| ì‘ê¸‰ ê°ì§€    | âœ…   | í‚¤ì›Œë“œ ë§¤ì¹­ + API ì•Œë¦¼       |
| í…ŒìŠ¤íŠ¸ ë„êµ¬  | âœ…   | test_websocket_client.py     |
| ë¬¸ì„œí™”       | âœ…   | API ëª…ì„¸ì„œ, ë°°í¬ ê°€ì´ë“œ      |

**íŒŒì¼ ëª©ë¡**:

- `backend/rk3588asr/asr_api_server.py` (550 ë¼ì¸)
- `backend/rk3588asr/test_websocket_client.py` (250 ë¼ì¸)
- `backend/rk3588asr/requirements_api.txt`
- `backend/rk3588asr/README_API.md`

### Phase 2: ë°±ì—”ë“œ ìˆ˜ì • (ì˜ˆì •)

| í•­ëª©           | ìƒíƒœ | ì„¤ëª…                              |
| -------------- | ---- | --------------------------------- |
| ASR í”„ë¡ì‹œ API | ğŸ“   | `/asr/devices/{id}/session/start` |
| WebSocket ì¤‘ê³„ | ğŸ“   | `/ws/asr/monitor/{device_id}`     |
| MQTT ëª…ë ¹ í™•ì¥ | ğŸ“   | `start_asr`, `stop_asr` ì•¡ì…˜      |
| ìŠ¤í‚¤ë§ˆ ì¶”ê°€    | ğŸ“   | `schemas/asr.py`                  |

### Phase 3: íŒì›¨ì–´ ìˆ˜ì • (ì˜ˆì •)

| í•­ëª©                 | ìƒíƒœ | ì„¤ëª…                                   |
| -------------------- | ---- | -------------------------------------- |
| WebSocket í´ë¼ì´ì–¸íŠ¸ | ğŸ“   | ArduinoWebsockets                      |
| ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°      | ğŸ“   | I2S â†’ Base64 â†’ WebSocket               |
| MQTT í•¸ë“¤ëŸ¬          | ğŸ“   | `handleMicrophoneControl("start_asr")` |
| ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€      | ğŸ“   | platformio.ini                         |

### Phase 4: í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ (ì˜ˆì •)

| í•­ëª©                  | ìƒíƒœ | ì„¤ëª…                   |
| --------------------- | ---- | ---------------------- |
| VoiceRecognitionPanel | ğŸ“   | ìŒì„±ì¸ì‹ íŒ¨ë„ ì»´í¬ë„ŒíŠ¸ |
| RecognitionChatWindow | ğŸ“   | ì±„íŒ… ì°½ ì»´í¬ë„ŒíŠ¸       |
| useASRWebSocket Hook  | ğŸ“   | WebSocket í†µì‹  Hook    |
| API ì—°ë™              | ğŸ“   | `lib/api.ts` í™•ì¥      |

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. ASR ì„œë²„ ì‹¤í–‰ (RK3588)

```bash
# SSH ì ‘ì†
ssh user@192.168.1.100

# ì„œë²„ ì‹¤í–‰
cd ~/asr_server
taskset 0x0F python3 asr_api_server.py --host 0.0.0.0 --port 8001
```

### 2. ë°±ì—”ë“œ ì‹¤í–‰ (ë¡œì»¬ PC)

```bash
cd backend
source ../venv/bin/activate  # Windows: .\venv\Scripts\Activate.ps1
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰

```bash
cd frontend
npm run dev
```

### 4. ì ‘ì† ë° í…ŒìŠ¤íŠ¸

- **í”„ë¡ íŠ¸ì—”ë“œ**: http://localhost:3000
- **ë°±ì—”ë“œ API**: http://localhost:8000/docs
- **ASR ì„œë²„**: http://192.168.1.100:8001/docs
- **Gradio UI**: https://192.168.1.100:7860

---

## ğŸ“š ì£¼ìš” API ì—”ë“œí¬ì¸íŠ¸

### ASR ì„œë²„ (port 8001)

| Method | Endpoint                   | ì„¤ëª…            |
| ------ | -------------------------- | --------------- |
| POST   | `/asr/session/start`       | ì„¸ì…˜ ìƒì„±       |
| GET    | `/asr/session/{id}/status` | ì„¸ì…˜ ìƒíƒœ       |
| POST   | `/asr/session/{id}/stop`   | ì„¸ì…˜ ì¢…ë£Œ       |
| WS     | `/ws/asr/{id}`             | ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë° |

### ë°±ì—”ë“œ (port 8000)

| Method | Endpoint                          | ì„¤ëª…               |
| ------ | --------------------------------- | ------------------ |
| POST   | `/asr/devices/{id}/session/start` | ì¥ë¹„ ìŒì„±ì¸ì‹ ì‹œì‘ |
| POST   | `/asr/devices/{id}/session/stop`  | ì¥ë¹„ ìŒì„±ì¸ì‹ ì¢…ë£Œ |
| WS     | `/ws/asr/monitor/{device_id}`     | ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§    |

---

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### ì¸ì¦

- JWT í† í° ê¸°ë°˜ ì¸ì¦ (Phase 2ì—ì„œ êµ¬í˜„)
- WebSocket ì„¸ì…˜ ID ê²€ì¦

### ë„¤íŠ¸ì›Œí¬

- HTTPS/WSS (í”„ë¡œë•ì…˜ í™˜ê²½)
- CORS ì„¤ì • (í—ˆìš© ë„ë©”ì¸ ì œí•œ)
- Rate Limiting

### ë°ì´í„°

- ì˜¤ë””ì˜¤ ë°ì´í„°: ì „ì†¡ í›„ ì¦‰ì‹œ ì‚­ì œ
- ì¸ì‹ ê²°ê³¼: í•„ìš”ì‹œ ì•”í˜¸í™” ì €ì¥
- ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ: 30ë¶„

---

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### RK3588 NPU í™œìš©

```bash
# 4ê°œ ì½”ì–´ ëª¨ë‘ ì‚¬ìš©
taskset 0x0F python asr_api_server.py
```

### ì˜¤ë””ì˜¤ ì„¤ì •

- ìƒ˜í”Œë ˆì´íŠ¸: 16000 Hz
- ì²­í¬ í¬ê¸°: 1024 samples (64ms)
- Base64 ì˜¤ë²„í—¤ë“œ: ~33%

### ìµœì í™” íŒ

- WebSocket keep-alive ì„¤ì •
- ì˜¤ë””ì˜¤ ë²„í¼ í¬ê¸° ì¡°ì •
- VAD ì„ê³„ê°’ íŠœë‹

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### ASR ì„œë²„ í…ŒìŠ¤íŠ¸

```bash
# ì˜¤ë””ì˜¤ íŒŒì¼ë¡œ í…ŒìŠ¤íŠ¸
cd backend/rk3588asr
python test_websocket_client.py --audio test.wav
```

### API í…ŒìŠ¤íŠ¸

```bash
# cURL
curl -X POST http://localhost:8001/asr/session/start \
  -H "Content-Type: application/json" \
  -d '{"device_id": "test_device"}'

# Python
python -c "
import requests
r = requests.post('http://localhost:8001/asr/session/start',
                  json={'device_id': 'test_device'})
print(r.json())
"
```

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œ

| ë¬¸ì œ                | í•´ê²° ë°©ë²•                              |
| ------------------- | -------------------------------------- |
| ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨      | ëª¨ë¸ ê²½ë¡œ í™•ì¸, demo_vad_final.py ìˆ˜ì • |
| WebSocket ì—°ê²° ëŠê¹€ | ë°©í™”ë²½ ì„¤ì •, ë„¤íŠ¸ì›Œí¬ ì•ˆì •ì„± í™•ì¸      |
| ì¸ì‹ ê²°ê³¼ ì—†ìŒ      | ì˜¤ë””ì˜¤ í˜•ì‹ í™•ì¸, VAD ì„ê³„ê°’ ì¡°ì •      |
| Base64 ë””ì½”ë”© ì˜¤ë¥˜  | ì¸ì½”ë”© í˜•ì‹ í™•ì¸, íŒ¨ë”© í™•ì¸            |

ìì„¸í•œ ë‚´ìš©ì€ `04_deployment_guide.md` ì°¸ê³ .

---

## ğŸ“– í•™ìŠµ ìë£Œ

### í•„ìˆ˜ ê°œë…

- **WebSocket**: ì–‘ë°©í–¥ ì‹¤ì‹œê°„ í†µì‹ 
- **Base64**: ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì¸ì½”ë”©
- **VAD**: ìŒì„± êµ¬ê°„ ìë™ ê°ì§€
- **PCM**: ë¹„ì••ì¶• ì˜¤ë””ì˜¤ í˜•ì‹
- **MQTT**: IoT ë©”ì‹œì§• í”„ë¡œí† ì½œ

### ì°¸ê³  ë¬¸ì„œ

- [Sherpa-ONNX ê³µì‹ ë¬¸ì„œ](https://k2-fsa.github.io/sherpa/onnx/)
- [FastAPI WebSocket](https://fastapi.tiangolo.com/advanced/websockets/)
- [ArduinoWebsockets](https://github.com/gilmaimon/ArduinoWebsockets)
- [WebSocket RFC6455](https://datatracker.ietf.org/doc/html/rfc6455)

---

## ğŸ¤ ê¸°ì—¬ ê°€ì´ë“œ

### ê°œë°œ í™˜ê²½ ì„¤ì •

1. ì €ì¥ì†Œ í´ë¡ 
2. ê°€ìƒí™˜ê²½ ìƒì„±
3. ì˜ì¡´ì„± ì„¤ì¹˜
4. í™˜ê²½ë³€ìˆ˜ ì„¤ì •

### ë¸Œëœì¹˜ ì „ëµ

- `main`: ì•ˆì • ë²„ì „
- `develop`: ê°œë°œ ë²„ì „
- `feature/*`: ê¸°ëŠ¥ ê°œë°œ
- `hotfix/*`: ê¸´ê¸‰ ìˆ˜ì •

### ì»¤ë°‹ ë©”ì‹œì§€

```
feat(asr): Add WebSocket audio streaming
fix(frontend): Fix chat window scroll
docs: Update API specification
```

---

## ğŸ“ TODO

### ë‹¨ê¸° (ì´ë²ˆ ì£¼)

- [ ] Phase 2: ë°±ì—”ë“œ í”„ë¡ì‹œ API êµ¬í˜„
- [ ] Phase 3: CoreS3 íŒì›¨ì–´ WebSocket í´ë¼ì´ì–¸íŠ¸
- [ ] Phase 4: í”„ë¡ íŠ¸ì—”ë“œ ìŒì„±ì¸ì‹ UI

### ì¤‘ê¸° (ë‹¤ìŒ ì£¼)

- [ ] ì¸ì¦ ì‹œìŠ¤í…œ í†µí•© (JWT)
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± (pytest, Jest)
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ìµœì í™”

### ì¥ê¸° (ë‹¤ìŒ ë‹¬)

- [ ] ë‹¤êµ­ì–´ ì§€ì› í™•ì¥
- [ ] ìŒì„± ê°ì • ë¶„ì„
- [ ] ì‹¤ì‹œê°„ ë²ˆì—­ ê¸°ëŠ¥

---

## ğŸ“ ì§€ì›

- **Issues**: GitHub Issues
- **Email**: support@example.com
- **ë¬¸ì„œ**: ì´ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  `.md` íŒŒì¼

---

## ğŸ“„ ë¼ì´ì„ ìŠ¤

MIT License

---

## ğŸ“ ì‘ì„±ì

**AI Assistant**  
ì‘ì„±ì¼: 2025-12-08  
ë²„ì „: 1.0.0

---

**ğŸ“š ë‹¤ìŒ ì½ì„ ë¬¸ì„œ**: `01_architecture.md` (ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ìƒì„¸)
